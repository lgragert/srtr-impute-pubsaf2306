#!/usr/bin/env python
###############################################################################
#   SCRIPT NAME:    hla_epitope_registry_generation.py
#   DESCRIPTION:    Impute Eplet Matrices with 9loc global data
#   SLURM:          hla_epitope_registry_generation_RUN.sh
#   OUTPUT:         ./hla_eplet_registry_SRTR_%a.csv
#   DATE:           June 6, 2023
#   AUTHOR:         Grace Lord (gwager@tulane.edu ; GitHub: gwager)
#   PI:             Loren Gragert, Ph.D.
#   ORGANIZATION:   Tulane University School of Medicine
#   NOTES:
###############################################################################

import json
import requests
import pandas as pd
import numpy as np
from datetime import datetime
import timeit
import itertools
import time

# read in api key file, saved locally and not checked in
EpReg_api_key_file = open ("HLA_EpReg_api_key.key")
EpReg_api_key = ""
for line in EpReg_api_key_file:
    EpReg_api_key = line

#eplet_dict = dict
#eplet_dataframe = pd.DataFrame()
#hla_outfile = open("./hlaR_replicates/hlaR_9loc_global_matrix_1.txt", 'r')
#print(hla_outfile)
#lines = hla_outfile.readlines()
#N= 1790
#start_all = timeit.default_timer()
#for line in lines:
#for line in  itertools.islice(lines, N):
sliced = 0 # Initialize variables
#with open("./hlaR_replicates/hlaR_9loc_global_matrix_1.txt", 'r') as f:
with open("./hlaR_9loc_global_matrix_1.txt", 'r') as f:
    while True:
        sliced = sliced + 1 
        
        # Read 100 lines at a time from the input file
        next_n_lines = list(itertools.islice(f, 100))
        if not next_n_lines:
            break

        # Simulate a delay between iterations
        time.sleep(60.0)

        # Create an empty DataFrame to store data from the current batch of lines
        eplet_dataframe = pd.DataFrame()

        # Process each line in the current batch
        for line in next_n_lines:
            (TX_ID,PX_ID,REC_TX_DT,ORG_TY,PERS_ID,TFL_DEATH_DT,REC_AGE_AT_TX,REC_TX_ORG_TY,CAN_GENDER,CAN_DGN,CAN_RACE,REC_COLD_ISCH_TM,CAN_AGE_DIAB,CAN_DIAB,CAN_DIAB_TY,CAN_ABO,REC_PREV_KI,REC_PREV_KP,REC_HGT_CM,REC_WGT_KG,REC_A_MM_EQUIV_CUR,REC_B_MM_EQUIV_CUR,REC_DR_MM_EQUIV_CUR,DON_TY,DON_AGE,DON_CAD_DON_COD,DON_GENDER,DON_RACE,DON_EXPAND_DON_KI,DON_RT_KI_PUMP,DON_LF_KI_PUMP,TFL_ENDTXFU,DON_CREAT,REC_MED_COND,REC_DGN,DON_KI_CREAT_PREOP,DON_HIST_HYPERTEN,DON_RELATIONSHIP_TY,TFL_LAFUDATE,PERS_RETX,REC_PRIMARY_PAY,REC_SECONDARY_PAY,REC_TX_PROCEDURE_TY,DON_HGT_CM,DON_WGT_KG,DON_ORG_SHARED,DON_NON_HR_BEAT,DON_HTN,REC_PRETX_TXFUS,DON_HIST_DIAB,REC_CMV_IGG,REC_CMV_IGM,DON_CMV_IGG,DON_ANTI_CMV,CAN_MALIG,TFL_GRAFT_DT,CAN_LAST_SRTR_PEAK_PRA,REC_DIAL_DT,DON_RELATIONSHIP_TY,CAN_SOURCE,REC_CREAT,REC_PREV_PREG,REC_FIRST_WEEK_DIAL,DONOR_ID,HAPPAIR_RECIP,HAPPAIR_DONOR,RECIP_HAP1,RECIP_HAP2,DONOR_HAP1,DONOR_HAP2,RECIP_A_1,RECIP_A_2,DONOR_A_1,DONOR_A_2,RECIP_C_1,RECIP_C_2,DONOR_C_1,DONOR_C_2,RECIP_B_1,RECIP_B_2,DONOR_B_1,DONOR_B_2,RECIP_DRW1_1,RECIP_DRW1_2,DONOR_DRW1_1,DONOR_DRW1_2,RECIP_DRB1_1,RECIP_DRB1_2,DONOR_DRB1_1,DONOR_DRB1_2,RECIP_DQA1_1,RECIP_DQA1_2,DONOR_DQA1_1,DONOR_DQA1_2,RECIP_DQB1_1,RECIP_DQB1_2,DONOR_DQB1_1,DONOR_DQB1_2,RECIP_DPA1_1,RECIP_DPA1_2,DONOR_DPA1_1,DONOR_DPA1_2,RECIP_DPB1_1,RECIP_DPB1_2,DONOR_DPB1_1,DONOR_DPB1_2,MM_A_1,MM_A_2,MM_A_3,MM_A_4,MM_A_5,MM_A_6,MM_A_7,MM_A_8,MM_A_9,MM_A_10,MM_A_11,MM_A_12,MM_A_13,MM_A_14,MM_A_15,MM_A_16,MM_A_17,MM_A_18,MM_A_19,MM_A_20,MM_A_21,MM_A_22,MM_A_23,MM_A_24,MM_A_25,MM_A_26,MM_A_27,MM_A_28,MM_A_29,MM_A_30,MM_A_31,MM_A_32,MM_A_33,MM_A_34,MM_A_35,MM_A_36,MM_A_37,MM_A_38,MM_A_39,MM_A_40,MM_A_41,MM_A_42,MM_A_43,MM_A_44,MM_A_45,MM_A_46,MM_A_47,MM_A_48,MM_A_49,MM_A_50,MM_A_51,MM_A_52,MM_A_53,MM_A_54,MM_A_55,MM_A_56,MM_A_57,MM_A_58,MM_A_59,MM_A_60,MM_A_61,MM_A_62,MM_A_63,MM_A_64,MM_A_65,MM_A_66,MM_A_67,MM_A_68,MM_A_69,MM_A_70,MM_A_71,MM_A_72,MM_A_73,MM_A_74,MM_A_75,MM_A_76,MM_A_77,MM_A_78,MM_A_79,MM_A_80,MM_A_81,MM_A_82,MM_A_83,MM_A_84,MM_A_85,MM_A_86,MM_A_87,MM_A_88,MM_A_89,MM_A_90,MM_A_91,MM_A_92,MM_A_93,MM_A_94,MM_A_95,MM_A_96,MM_A_97,MM_A_98,MM_A_99,MM_A_100,MM_A_101,MM_A_102,MM_A_103,MM_A_104,MM_A_105,MM_A_106,MM_A_107,MM_A_108,MM_A_109,MM_A_110,MM_A_111,MM_A_112,MM_A_113,MM_A_114,MM_A_115,MM_A_116,MM_A_117,MM_A_118,MM_A_119,MM_A_120,MM_A_121,MM_A_122,MM_A_123,MM_A_124,MM_A_125,MM_A_126,MM_A_127,MM_A_128,MM_A_129,MM_A_130,MM_A_131,MM_A_132,MM_A_133,MM_A_134,MM_A_135,MM_A_136,MM_A_137,MM_A_138,MM_A_139,MM_A_140,MM_A_141,MM_A_142,MM_A_143,MM_A_144,MM_A_145,MM_A_146,MM_A_147,MM_A_148,MM_A_149,MM_A_150,MM_A_151,MM_A_152,MM_A_153,MM_A_154,MM_A_155,MM_A_156,MM_A_157,MM_A_158,MM_A_159,MM_A_160,MM_A_161,MM_A_162,MM_A_163,MM_A_164,MM_A_165,MM_A_166,MM_A_167,MM_A_168,MM_A_169,MM_A_170,MM_A_171,MM_A_172,MM_A_173,MM_A_174,MM_A_175,MM_A_176,MM_A_177,MM_A_178,MM_A_179,MM_A_180,MM_A_181,MM_A_182,MM_A_183,MM_A_184,MM_A_185,MM_A_186,MM_A_187,MM_A_188,MM_A_189,MM_A_190,MM_A_191,MM_A_192,MM_A_193,MM_A_194,MM_A_195,MM_A_196,MM_A_197,MM_A_198,MM_A_199,MM_A_COUNT,MM_C_1,MM_C_2,MM_C_3,MM_C_4,MM_C_5,MM_C_6,MM_C_7,MM_C_8,MM_C_9,MM_C_10,MM_C_11,MM_C_12,MM_C_13,MM_C_14,MM_C_15,MM_C_16,MM_C_17,MM_C_18,MM_C_19,MM_C_20,MM_C_21,MM_C_22,MM_C_23,MM_C_24,MM_C_25,MM_C_26,MM_C_27,MM_C_28,MM_C_29,MM_C_30,MM_C_31,MM_C_32,MM_C_33,MM_C_34,MM_C_35,MM_C_36,MM_C_37,MM_C_38,MM_C_39,MM_C_40,MM_C_41,MM_C_42,MM_C_43,MM_C_44,MM_C_45,MM_C_46,MM_C_47,MM_C_48,MM_C_49,MM_C_50,MM_C_51,MM_C_52,MM_C_53,MM_C_54,MM_C_55,MM_C_56,MM_C_57,MM_C_58,MM_C_59,MM_C_60,MM_C_61,MM_C_62,MM_C_63,MM_C_64,MM_C_65,MM_C_66,MM_C_67,MM_C_68,MM_C_69,MM_C_70,MM_C_71,MM_C_72,MM_C_73,MM_C_74,MM_C_75,MM_C_76,MM_C_77,MM_C_78,MM_C_79,MM_C_80,MM_C_81,MM_C_82,MM_C_83,MM_C_84,MM_C_85,MM_C_86,MM_C_87,MM_C_88,MM_C_89,MM_C_90,MM_C_91,MM_C_92,MM_C_93,MM_C_94,MM_C_95,MM_C_96,MM_C_97,MM_C_98,MM_C_99,MM_C_100,MM_C_101,MM_C_102,MM_C_103,MM_C_104,MM_C_105,MM_C_106,MM_C_107,MM_C_108,MM_C_109,MM_C_110,MM_C_111,MM_C_112,MM_C_113,MM_C_114,MM_C_115,MM_C_116,MM_C_117,MM_C_118,MM_C_119,MM_C_120,MM_C_121,MM_C_122,MM_C_123,MM_C_124,MM_C_125,MM_C_126,MM_C_127,MM_C_128,MM_C_129,MM_C_130,MM_C_131,MM_C_132,MM_C_133,MM_C_134,MM_C_135,MM_C_136,MM_C_137,MM_C_138,MM_C_139,MM_C_140,MM_C_141,MM_C_142,MM_C_143,MM_C_144,MM_C_145,MM_C_146,MM_C_147,MM_C_148,MM_C_149,MM_C_150,MM_C_151,MM_C_152,MM_C_153,MM_C_154,MM_C_155,MM_C_156,MM_C_157,MM_C_158,MM_C_159,MM_C_160,MM_C_161,MM_C_162,MM_C_163,MM_C_164,MM_C_165,MM_C_166,MM_C_167,MM_C_168,MM_C_169,MM_C_170,MM_C_171,MM_C_172,MM_C_173,MM_C_174,MM_C_175,MM_C_176,MM_C_177,MM_C_178,MM_C_179,MM_C_180,MM_C_181,MM_C_182,MM_C_183,MM_C_184,MM_C_185,MM_C_186,MM_C_187,MM_C_188,MM_C_189,MM_C_190,MM_C_191,MM_C_192,MM_C_193,MM_C_194,MM_C_195,MM_C_196,MM_C_197,MM_C_198,MM_C_199,MM_C_200,MM_C_201,MM_C_202,MM_C_203,MM_C_204,MM_C_205,MM_C_COUNT,MM_B_1,MM_B_2,MM_B_3,MM_B_4,MM_B_5,MM_B_6,MM_B_7,MM_B_8,MM_B_9,MM_B_10,MM_B_11,MM_B_12,MM_B_13,MM_B_14,MM_B_15,MM_B_16,MM_B_17,MM_B_18,MM_B_19,MM_B_20,MM_B_21,MM_B_22,MM_B_23,MM_B_24,MM_B_25,MM_B_26,MM_B_27,MM_B_28,MM_B_29,MM_B_30,MM_B_31,MM_B_32,MM_B_33,MM_B_34,MM_B_35,MM_B_36,MM_B_37,MM_B_38,MM_B_39,MM_B_40,MM_B_41,MM_B_42,MM_B_43,MM_B_44,MM_B_45,MM_B_46,MM_B_47,MM_B_48,MM_B_49,MM_B_50,MM_B_51,MM_B_52,MM_B_53,MM_B_54,MM_B_55,MM_B_56,MM_B_57,MM_B_58,MM_B_59,MM_B_60,MM_B_61,MM_B_62,MM_B_63,MM_B_64,MM_B_65,MM_B_66,MM_B_67,MM_B_68,MM_B_69,MM_B_70,MM_B_71,MM_B_72,MM_B_73,MM_B_74,MM_B_75,MM_B_76,MM_B_77,MM_B_78,MM_B_79,MM_B_80,MM_B_81,MM_B_82,MM_B_83,MM_B_84,MM_B_85,MM_B_86,MM_B_87,MM_B_88,MM_B_89,MM_B_90,MM_B_91,MM_B_92,MM_B_93,MM_B_94,MM_B_95,MM_B_96,MM_B_97,MM_B_98,MM_B_99,MM_B_100,MM_B_101,MM_B_102,MM_B_103,MM_B_104,MM_B_105,MM_B_106,MM_B_107,MM_B_108,MM_B_109,MM_B_110,MM_B_111,MM_B_112,MM_B_113,MM_B_114,MM_B_115,MM_B_116,MM_B_117,MM_B_118,MM_B_119,MM_B_120,MM_B_121,MM_B_122,MM_B_123,MM_B_124,MM_B_125,MM_B_126,MM_B_127,MM_B_128,MM_B_129,MM_B_130,MM_B_131,MM_B_132,MM_B_133,MM_B_134,MM_B_135,MM_B_136,MM_B_137,MM_B_138,MM_B_139,MM_B_140,MM_B_141,MM_B_142,MM_B_143,MM_B_144,MM_B_145,MM_B_146,MM_B_147,MM_B_148,MM_B_149,MM_B_150,MM_B_151,MM_B_152,MM_B_153,MM_B_154,MM_B_155,MM_B_156,MM_B_157,MM_B_158,MM_B_159,MM_B_160,MM_B_161,MM_B_162,MM_B_163,MM_B_164,MM_B_165,MM_B_166,MM_B_167,MM_B_168,MM_B_169,MM_B_170,MM_B_171,MM_B_172,MM_B_173,MM_B_174,MM_B_175,MM_B_176,MM_B_177,MM_B_178,MM_B_179,MM_B_180,MM_B_181,MM_B_182,MM_B_183,MM_B_184,MM_B_185,MM_B_186,MM_B_187,MM_B_188,MM_B_189,MM_B_190,MM_B_191,MM_B_192,MM_B_193,MM_B_194,MM_B_COUNT,MM_DRW1_1,MM_DRW1_2,MM_DRW1_3,MM_DRW1_4,MM_DRW1_5,MM_DRW1_6,MM_DRW1_7,MM_DRW1_8,MM_DRW1_9,MM_DRW1_10,MM_DRW1_11,MM_DRW1_12,MM_DRW1_13,MM_DRW1_14,MM_DRW1_15,MM_DRW1_16,MM_DRW1_17,MM_DRW1_18,MM_DRW1_19,MM_DRW1_20,MM_DRW1_21,MM_DRW1_22,MM_DRW1_23,MM_DRW1_24,MM_DRW1_25,MM_DRW1_26,MM_DRW1_27,MM_DRW1_28,MM_DRW1_29,MM_DRW1_30,MM_DRW1_31,MM_DRW1_32,MM_DRW1_33,MM_DRW1_34,MM_DRW1_35,MM_DRW1_36,MM_DRW1_37,MM_DRW1_38,MM_DRW1_39,MM_DRW1_40,MM_DRW1_41,MM_DRW1_42,MM_DRW1_43,MM_DRW1_44,MM_DRW1_45,MM_DRW1_46,MM_DRW1_47,MM_DRW1_48,MM_DRW1_49,MM_DRW1_50,MM_DRW1_51,MM_DRW1_52,MM_DRW1_53,MM_DRW1_54,MM_DRW1_55,MM_DRW1_56,MM_DRW1_57,MM_DRW1_58,MM_DRW1_59,MM_DRW1_60,MM_DRW1_61,MM_DRW1_62,MM_DRW1_63,MM_DRW1_64,MM_DRW1_65,MM_DRW1_66,MM_DRW1_67,MM_DRW1_68,MM_DRW1_69,MM_DRW1_70,MM_DRW1_71,MM_DRW1_72,MM_DRW1_73,MM_DRW1_74,MM_DRW1_75,MM_DRW1_76,MM_DRW1_77,MM_DRW1_78,MM_DRW1_79,MM_DRW1_80,MM_DRW1_81,MM_DRW1_82,MM_DRW1_83,MM_DRW1_84,MM_DRW1_85,MM_DRW1_86,MM_DRW1_87,MM_DRW1_88,MM_DRW1_89,MM_DRW1_90,MM_DRW1_91,MM_DRW1_92,MM_DRW1_93,MM_DRW1_94,MM_DRW1_COUNT,MM_DRB1_1,MM_DRB1_2,MM_DRB1_3,MM_DRB1_4,MM_DRB1_5,MM_DRB1_6,MM_DRB1_7,MM_DRB1_8,MM_DRB1_9,MM_DRB1_10,MM_DRB1_11,MM_DRB1_12,MM_DRB1_13,MM_DRB1_14,MM_DRB1_15,MM_DRB1_16,MM_DRB1_17,MM_DRB1_18,MM_DRB1_19,MM_DRB1_20,MM_DRB1_21,MM_DRB1_22,MM_DRB1_23,MM_DRB1_24,MM_DRB1_25,MM_DRB1_26,MM_DRB1_27,MM_DRB1_28,MM_DRB1_29,MM_DRB1_30,MM_DRB1_31,MM_DRB1_32,MM_DRB1_33,MM_DRB1_34,MM_DRB1_35,MM_DRB1_36,MM_DRB1_37,MM_DRB1_38,MM_DRB1_39,MM_DRB1_40,MM_DRB1_41,MM_DRB1_42,MM_DRB1_43,MM_DRB1_44,MM_DRB1_45,MM_DRB1_46,MM_DRB1_47,MM_DRB1_48,MM_DRB1_49,MM_DRB1_50,MM_DRB1_51,MM_DRB1_52,MM_DRB1_53,MM_DRB1_54,MM_DRB1_55,MM_DRB1_56,MM_DRB1_57,MM_DRB1_58,MM_DRB1_59,MM_DRB1_60,MM_DRB1_61,MM_DRB1_62,MM_DRB1_63,MM_DRB1_64,MM_DRB1_65,MM_DRB1_66,MM_DRB1_67,MM_DRB1_68,MM_DRB1_69,MM_DRB1_70,MM_DRB1_71,MM_DRB1_72,MM_DRB1_73,MM_DRB1_74,MM_DRB1_75,MM_DRB1_76,MM_DRB1_77,MM_DRB1_78,MM_DRB1_79,MM_DRB1_80,MM_DRB1_81,MM_DRB1_82,MM_DRB1_83,MM_DRB1_84,MM_DRB1_85,MM_DRB1_86,MM_DRB1_87,MM_DRB1_88,MM_DRB1_89,MM_DRB1_90,MM_DRB1_91,MM_DRB1_92,MM_DRB1_93,MM_DRB1_94,MM_DRB1_COUNT,MM_DQA1_1,MM_DQA1_2,MM_DQA1_3,MM_DQA1_4,MM_DQA1_5,MM_DQA1_6,MM_DQA1_7,MM_DQA1_8,MM_DQA1_9,MM_DQA1_10,MM_DQA1_11,MM_DQA1_12,MM_DQA1_13,MM_DQA1_14,MM_DQA1_15,MM_DQA1_16,MM_DQA1_17,MM_DQA1_18,MM_DQA1_19,MM_DQA1_20,MM_DQA1_21,MM_DQA1_22,MM_DQA1_23,MM_DQA1_24,MM_DQA1_25,MM_DQA1_26,MM_DQA1_27,MM_DQA1_28,MM_DQA1_29,MM_DQA1_30,MM_DQA1_31,MM_DQA1_32,MM_DQA1_33,MM_DQA1_34,MM_DQA1_35,MM_DQA1_36,MM_DQA1_37,MM_DQA1_38,MM_DQA1_39,MM_DQA1_40,MM_DQA1_41,MM_DQA1_42,MM_DQA1_43,MM_DQA1_44,MM_DQA1_45,MM_DQA1_46,MM_DQA1_47,MM_DQA1_48,MM_DQA1_49,MM_DQA1_50,MM_DQA1_51,MM_DQA1_52,MM_DQA1_53,MM_DQA1_54,MM_DQA1_55,MM_DQA1_56,MM_DQA1_57,MM_DQA1_58,MM_DQA1_59,MM_DQA1_60,MM_DQA1_61,MM_DQA1_62,MM_DQA1_63,MM_DQA1_64,MM_DQA1_65,MM_DQA1_66,MM_DQA1_67,MM_DQA1_68,MM_DQA1_69,MM_DQA1_70,MM_DQA1_71,MM_DQA1_72,MM_DQA1_73,MM_DQA1_74,MM_DQA1_75,MM_DQA1_76,MM_DQA1_77,MM_DQA1_78,MM_DQA1_79,MM_DQA1_80,MM_DQA1_81,MM_DQA1_82,MM_DQA1_83,MM_DQA1_84,MM_DQA1_85,MM_DQA1_86,MM_DQA1_87,MM_DQA1_88,MM_DQA1_89,MM_DQA1_90,MM_DQA1_91,MM_DQA1_92,MM_DQA1_93,MM_DQA1_COUNT,MM_DQB1_1,MM_DQB1_2,MM_DQB1_3,MM_DQB1_4,MM_DQB1_5,MM_DQB1_6,MM_DQB1_7,MM_DQB1_8,MM_DQB1_9,MM_DQB1_10,MM_DQB1_11,MM_DQB1_12,MM_DQB1_13,MM_DQB1_14,MM_DQB1_15,MM_DQB1_16,MM_DQB1_17,MM_DQB1_18,MM_DQB1_19,MM_DQB1_20,MM_DQB1_21,MM_DQB1_22,MM_DQB1_23,MM_DQB1_24,MM_DQB1_25,MM_DQB1_26,MM_DQB1_27,MM_DQB1_28,MM_DQB1_29,MM_DQB1_30,MM_DQB1_31,MM_DQB1_32,MM_DQB1_33,MM_DQB1_34,MM_DQB1_35,MM_DQB1_36,MM_DQB1_37,MM_DQB1_38,MM_DQB1_39,MM_DQB1_40,MM_DQB1_41,MM_DQB1_42,MM_DQB1_43,MM_DQB1_44,MM_DQB1_45,MM_DQB1_46,MM_DQB1_47,MM_DQB1_48,MM_DQB1_49,MM_DQB1_50,MM_DQB1_51,MM_DQB1_52,MM_DQB1_53,MM_DQB1_54,MM_DQB1_55,MM_DQB1_56,MM_DQB1_57,MM_DQB1_58,MM_DQB1_59,MM_DQB1_60,MM_DQB1_61,MM_DQB1_62,MM_DQB1_63,MM_DQB1_64,MM_DQB1_65,MM_DQB1_66,MM_DQB1_67,MM_DQB1_68,MM_DQB1_69,MM_DQB1_70,MM_DQB1_71,MM_DQB1_72,MM_DQB1_73,MM_DQB1_74,MM_DQB1_75,MM_DQB1_76,MM_DQB1_77,MM_DQB1_78,MM_DQB1_79,MM_DQB1_80,MM_DQB1_81,MM_DQB1_82,MM_DQB1_83,MM_DQB1_84,MM_DQB1_85,MM_DQB1_86,MM_DQB1_87,MM_DQB1_88,MM_DQB1_89,MM_DQB1_90,MM_DQB1_91,MM_DQB1_92,MM_DQB1_93,MM_DQB1_94,MM_DQB1_COUNT,MM_DPA1_1,MM_DPA1_2,MM_DPA1_3,MM_DPA1_4,MM_DPA1_5,MM_DPA1_6,MM_DPA1_7,MM_DPA1_8,MM_DPA1_9,MM_DPA1_10,MM_DPA1_11,MM_DPA1_12,MM_DPA1_13,MM_DPA1_14,MM_DPA1_15,MM_DPA1_16,MM_DPA1_17,MM_DPA1_18,MM_DPA1_19,MM_DPA1_20,MM_DPA1_21,MM_DPA1_22,MM_DPA1_23,MM_DPA1_24,MM_DPA1_25,MM_DPA1_26,MM_DPA1_27,MM_DPA1_28,MM_DPA1_29,MM_DPA1_30,MM_DPA1_31,MM_DPA1_32,MM_DPA1_33,MM_DPA1_34,MM_DPA1_35,MM_DPA1_36,MM_DPA1_37,MM_DPA1_38,MM_DPA1_39,MM_DPA1_40,MM_DPA1_41,MM_DPA1_42,MM_DPA1_43,MM_DPA1_44,MM_DPA1_45,MM_DPA1_46,MM_DPA1_47,MM_DPA1_48,MM_DPA1_49,MM_DPA1_50,MM_DPA1_51,MM_DPA1_52,MM_DPA1_53,MM_DPA1_54,MM_DPA1_55,MM_DPA1_56,MM_DPA1_57,MM_DPA1_58,MM_DPA1_59,MM_DPA1_60,MM_DPA1_61,MM_DPA1_62,MM_DPA1_63,MM_DPA1_64,MM_DPA1_65,MM_DPA1_66,MM_DPA1_67,MM_DPA1_68,MM_DPA1_69,MM_DPA1_70,MM_DPA1_71,MM_DPA1_72,MM_DPA1_73,MM_DPA1_74,MM_DPA1_75,MM_DPA1_76,MM_DPA1_77,MM_DPA1_78,MM_DPA1_79,MM_DPA1_80,MM_DPA1_81,MM_DPA1_82,MM_DPA1_83,MM_DPA1_84,MM_DPA1_85,MM_DPA1_86,MM_DPA1_87,MM_DPA1_88,MM_DPA1_89,MM_DPA1_90,MM_DPA1_91,MM_DPA1_92,MM_DPA1_93,MM_DPA1_COUNT,MM_DPB1_1,MM_DPB1_2,MM_DPB1_3,MM_DPB1_4,MM_DPB1_5,MM_DPB1_6,MM_DPB1_7,MM_DPB1_8,MM_DPB1_9,MM_DPB1_10,MM_DPB1_11,MM_DPB1_12,MM_DPB1_13,MM_DPB1_14,MM_DPB1_15,MM_DPB1_16,MM_DPB1_17,MM_DPB1_18,MM_DPB1_19,MM_DPB1_20,MM_DPB1_21,MM_DPB1_22,MM_DPB1_23,MM_DPB1_24,MM_DPB1_25,MM_DPB1_26,MM_DPB1_27,MM_DPB1_28,MM_DPB1_29,MM_DPB1_30,MM_DPB1_31,MM_DPB1_32,MM_DPB1_33,MM_DPB1_34,MM_DPB1_35,MM_DPB1_36,MM_DPB1_37,MM_DPB1_38,MM_DPB1_39,MM_DPB1_40,MM_DPB1_41,MM_DPB1_42,MM_DPB1_43,MM_DPB1_44,MM_DPB1_45,MM_DPB1_46,MM_DPB1_47,MM_DPB1_48,MM_DPB1_49,MM_DPB1_50,MM_DPB1_51,MM_DPB1_52,MM_DPB1_53,MM_DPB1_54,MM_DPB1_55,MM_DPB1_56,MM_DPB1_57,MM_DPB1_58,MM_DPB1_59,MM_DPB1_60,MM_DPB1_61,MM_DPB1_62,MM_DPB1_63,MM_DPB1_64,MM_DPB1_65,MM_DPB1_66,MM_DPB1_67,MM_DPB1_68,MM_DPB1_69,MM_DPB1_70,MM_DPB1_71,MM_DPB1_72,MM_DPB1_73,MM_DPB1_74,MM_DPB1_75,MM_DPB1_76,MM_DPB1_77,MM_DPB1_78,MM_DPB1_79,MM_DPB1_80,MM_DPB1_81,MM_DPB1_82,MM_DPB1_83,MM_DPB1_84,MM_DPB1_85,MM_DPB1_86,MM_DPB1_87,MM_DPB1_88,MM_DPB1_89,MM_DPB1_90,MM_DPB1_91,MM_DPB1_92,MM_DPB1_93,MM_DPB1_94,MM_DPB1_95,MM_DPB1_96,MM_DPB1_97,MM_DPB1_98,MM_DPB1_99,MM_DPB1_100,MM_DPB1_COUNT) = line.split("\t")
            #print(line)
            if TX_ID == "TX_ID":
                continue

            if (DONOR_DRB1_1 == 'DRBX*NNNN' or DONOR_DRB1_2 == 'DRBX*NNNN' or DONOR_DRW1_1 == 'DRBX*NNNN' or DONOR_DRW1_2 == 'DRBX*NNNN' or RECIP_DRB1_1 == 'DRBX*NNNN' or RECIP_DRB1_2 == 'DRBX*NNNN' or RECIP_DRW1_1 == 'DRBX*NNNN' or RECIP_DRW1_2 == 'DRBX*NNNN'):
                continue

            immunizer_string = DONOR_A_1+",,,"+ DONOR_A_2+",,,"+  DONOR_B_1+",,,"+ DONOR_B_2+",,,"+ DONOR_C_1+",,,"+ DONOR_C_2+",,,"+ DONOR_DRB1_1+",,,"+ DONOR_DRB1_2+",,,"+ DONOR_DRW1_1+",,,"+ DONOR_DRW1_2+",,,"+ DONOR_DQA1_1+",,,"+DONOR_DQA1_2+",,,"+DONOR_DQB1_1+",,,"+DONOR_DQB1_2
            #+",,,"+ DONOR_DPA1_1,DONOR_DPA1_2+",,,"+DONOR_DPB1_1+",,,"+DONOR_DPB1_2
            patient_string = RECIP_A_1+",,,"+ RECIP_A_2+",,,"+ RECIP_B_1+",,,"+ RECIP_B_2+",,,"+ RECIP_C_1+",,,"+ RECIP_C_2+",,,"+ RECIP_DRB1_1+",,,"+ RECIP_DRB1_2+",,,"+ RECIP_DRW1_1+",,,"+ RECIP_DRW1_2+",,,"+ RECIP_DQA1_1+",,,"+ RECIP_DQA1_2+",,,"+ RECIP_DQB1_1+",,,"+ RECIP_DQB1_2
            #+",,,"+ RECIP_DPA1_1+",,,"+RECIP_DPA1_2+",,,"+RECIP_DPB1_1+",,,"+RECIP_DPB1_2
            request_path = f'https://api.epregistry.com.br/eplet_mismatches?from={EpReg_api_key}&immunizer_alleles={immunizer_string}&patient_alleles={patient_string}'
            #print(immunizer_string)
            r = requests.get(request_path, headers={'Accept': 'application/json'})
            out_put = r.json()

            #print(f"Status Code: {r.status_code}, Content: {r.json()}")

            #out_put = f"Content: {r.json()}"
            #print(PX_ID, ":", out_put)
            #valid_json_string = "[{0}]".format(out_put)
            #print(valid_json_string)
            #eplet_dict = json.loads(valid_json_string)
            #print(eplet_dict)

            for key, value in out_put.items():
                #print(key)
                #(value)
                for labels, extended in value.items():
                    #print(labels)
                    #print(extended)
                    named = key + "_"+labels
                    eplet_dict = { 'PX_ID': PX_ID, named : extended}
                    eplet_dataframe = eplet_dataframe.append(eplet_dict, ignore_index = True)

                    #eplet_dict.append({
                    #    named : extended
                    #})
            #print(eplet_dict)
            # eplet_dict = json.loads(out_put)
            eplet_dataframe = eplet_dataframe.groupby(eplet_dataframe['PX_ID']).aggregate({'PX_ID': 'first','ABC_quantity':'sum',	'ABC_details':'sum',	'ABC_explanation':'sum',	'ALL_quantity':'sum',	'ALL_details':'sum',	'ALL_explanation':'sum',	'DRB_quantity':'sum',	'DRB_details':'sum',	'DRB_explanation':'sum',	'DQ_quantity':'sum',	'DQ_details':'sum',	'DQ_explanation':'sum',	'DP_quantity':'sum',	'DP_details':'sum',	'DP_explanation':'sum',	'MICA_quantity':'sum',	'MICA_details':'sum',	'MICA_explanation':'sum'})

            #eplet_dataframe = pd.DataFrame(eplet_dict)
            #design_matrix_filename = "./hla_eplet_registry_SRTR_"+str(sliced)+".csv"
            design_matrix_filename = "./hla_epitope_registry_06_21_23/hla_eplet_registry_SRTR_"+str(sliced)+".csv"
            eplet_dataframe.to_csv(design_matrix_filename,index=False,sep=",")
            time.sleep(2.0)

#print("DURATION of 1000 PX_IDS:", timeit.default_timer()-start_all)
